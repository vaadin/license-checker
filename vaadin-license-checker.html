<link rel="import" href="vaadin-license-box.html">

<!-- Validates Vaadin Subscription licenses -->

<script>
  class LicenseCheckerLogger {
    constructor() {
      this.id = "vaadin-license-checker";
    }

    isDebug() {
      return localStorage.getItem("vaadin.licenses.debug");
    }

    debug(msg) {
      if (this.isDebug()) {
        console.info(this.id + ": " + msg);
      }
    }
  }
  class LicenseCheckerStorage {
    constructor() {
      this.logger = new LicenseCheckerLogger();
    }
    getLastCheckKey(productInfo) {
      return "vaadin.licenses.{product}.lastCheck".replace("{product}", productInfo.name);
    }

    getLastCheck(productInfo) {
      return Number(localStorage.getItem(this.getLastCheckKey(productInfo)));
    }

    setLastCheck(productInfo, timestamp) {
      this.logger.debug("Setting last check time to " + new Date(timestamp));
      localStorage.setItem(this.getLastCheckKey(productInfo), timestamp);
    }
  }

  class VaadinLicenseChecker {
    constructor() {
      this.okNotifier = new LicenseOkNotifier();
      this.validationNeededNotifier = new LicenseValidationNeededNotifier();
      this.storage = new LicenseCheckerStorage();
      this.checkInterval = 1000 * 60 * 60 * 24;
      this.logger = new LicenseCheckerLogger();
      this.url = "https://tools.vaadin.com/vaadin-license-server/licenses/pro";
    }

    static get version() {
      return '2.0.0';
    }

    getForcedResponseKey(productInfo) {
      return 'vaadin.licenses.{product}.forcedResponse'.replace('{product}', productInfo.name);
    }

    getForcedResponse(productInfo) {
      return localStorage.getItem(this.getForcedResponseKey(productInfo));
    }
    clearForcedResponse(productInfo) {
      return localStorage.removeItem(this.getForcedResponseKey(productInfo));
    }

    maybeCheck(productInfo) {
      this.logger.debug("maybeCheck(" + JSON.stringify(productInfo) + ")");
      // Defer first check until interval has expired to avoid interfering with tests etc
      const now = new Date().getTime();
      const lastCheck = this.storage.getLastCheck(productInfo);
      if (!lastCheck) {
        this.logger.debug("Deferring first check until " + new Date(now + this.checkInterval));
        this.storage.setLastCheck(productInfo, now);
        return;
      } else {
        const sinceLastCheck = Math.round((now - lastCheck) / 1000);
        const nextCheck = Math.round(this.checkInterval / 1000 - sinceLastCheck);
        if (nextCheck > 0) {
          // Checked recently
          const nextCheckDate = new Date(lastCheck + this.checkInterval);
          this.logger.debug("Checked " + sinceLastCheck + "s ago. Next check in " + nextCheck + "s at " + nextCheckDate + ".");
          return;
        } else {
          this.logger.debug("Last check was " + sinceLastCheck + "s ago.");
        }
      }
      this.check(productInfo);
    }

    check(productInfo) {
      this.logger.debug("check(" + JSON.stringify(productInfo) + ")");

      // Only show an ok notification if the "validation needed" notification was shown.
      // For background checks, show no visual notification if all goes well
      var showOkOnSuccess = this.validationNeededNotifier.isVisible(productInfo);

      const checker = this;
      const onerror = function () {
        // Offline or blocked, just log to console and let people get work done
        console.error("Unable to validate the license for " + productInfo.name + ". Check your internet access.");
      };
      const onresponse = function (responseText) {
        const response = JSON.parse(responseText);
        if (response.result == "ok") {
          // Everything is fine, stop
          checker.logger.debug("License check ok for " + JSON.stringify(productInfo));
          checker.storage.setLastCheck(productInfo, new Date().getTime());
          if (showOkOnSuccess) {
            checker.logger.debug("Showing validation-ok dialog");
            checker.okNotifier.show(productInfo);
          }
        } else {
          checker.logger.debug("License check failed for " + JSON.stringify(productInfo));
          checker.logger.debug("Showing validation-needed dialog");
          checker.validationNeededNotifier.show(productInfo);
        }
        if (response.message) {
          console.log(response.message);
        }
      };

      // This is typically hidden already but when receiving a window message it is not
      this.logger.debug("Ensuring validation-needed dialog is hidden");
      this.validationNeededNotifier.hide(productInfo);

      if (this.logger.isDebug() && this.getForcedResponse(productInfo)) {
        const respJson = this.getForcedResponse(productInfo);
        this.clearForcedResponse(productInfo);
        if (JSON.parse(respJson).type == "error") {
          this.logger.debug("Forced error for check");
          onerror();
        } else {
          this.logger.debug("Forced response for check: " + respJson);
          onresponse(respJson);
        }
      } else {
        this.send(this.url, productInfo, onresponse, onerror);
      }
    }
    send(url, productInfo, onsuccess, onerror) {
      this.logger.debug("Sending request to " + url);
      var req = new XMLHttpRequest();
      req.withCredentials = true;
      req.addEventListener("readystatechange", function () {
        if (req.readyState === XMLHttpRequest.DONE && req.status === 200) {
          onsuccess(req.responseText);
        }
      });
      req.addEventListener("error", function () {
        onerror();
      });
      req.open("GET", url);
      req.setRequestHeader("check-source","webcomponent");
      req.setRequestHeader("product-name", productInfo.name);
      req.setRequestHeader("product-version", productInfo.version);

      req.send();
    };
  }
  class LicenseOkNotifier {
    static get id() {
      return 'vaadin-license-validation-ok';
    }
    getInstance() {
      return document.getElementById(LicenseOkNotifier.id);
    }
    show(productInfo) {
      // Only show one ok box even if multiple licenses were checked
      if (this.getInstance()) {
        // Already shown
        return;
      }
      const instance = document.createElement("vaadin-license-box");
      instance.id = LicenseOkNotifier.id;
      instance.type = "ok";
      instance.content = "Your license has been validated";
      document.body.appendChild(instance);
      instance.addEventListener("click", function () {
        instance.parentElement.removeChild(instance);
      });
    }
  }
  class LicenseValidationNeededNotifier {
    id(productInfo) {
      return "vaadin-license-validation-notification-{product}".replace("{product}", productInfo.name);
    }
    getInstance(productInfo) {
      return document.getElementById(this.id(productInfo));
    }
    show(productInfo) {
      if (this.getInstance(productInfo)) {
        // Already shown
        return;
      }
      const instance = document.createElement("vaadin-license-box");
      instance.id = this.id(productInfo);
      instance.type = "needsvalidation";
      instance.content = "Click to validate your Vaadin Subscription";
      document.body.appendChild(instance);
      instance.addEventListener("click", function () {
        window.open("https://vaadin.com/pro/validate-license", "_blank");
      });
    }
    hide(productInfo) {
      const instance = this.getInstance(productInfo);
      if (instance) {
        instance.parentElement.removeChild(instance);
      }
    }
    isVisible(productInfo) {
      return !!this.getInstance(productInfo);
    }
  }
  
  const proProducts = [];

  window.Vaadin = window.Vaadin || {};
  window.Vaadin.LicenseChecker = window.Vaadin.VaadinLicenseChecker || new VaadinLicenseChecker();
  window.Vaadin.LicenseCheckerClass = window.Vaadin.LicenseCheckerClass || VaadinLicenseChecker;
  window.Vaadin.developmentModeCallback = window.Vaadin.developmentModeCallback || {};
  window.Vaadin.developmentModeCallback["vaadin-license-checker"] = function (cls) {
    var productInfo = { name: cls.is, version: cls.version };
    proProducts.push(productInfo);
    window.addEventListener("message", function (e) {
      if (e.data == "validate-license") {
        window.Vaadin.LicenseChecker.check(productInfo);
      }
    }, false);

    window.Vaadin.checkLicenses = function () {
      // Force checking of all licenses to avoid e.g. popups during presentations when the grace period just has ended
      proProducts.forEach(productInfo => {
        window.Vaadin.LicenseChecker.check(productInfo);
      });
    }

    window.Vaadin.LicenseChecker.maybeCheck(productInfo);
  };
</script>